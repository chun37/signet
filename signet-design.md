# Signet 設計書

友人間の現金貸し借り記録を共有するためのプライベートブロックチェーンアプリケーション。

## 1. 概要

### 1.1 目的

- 10人弱の友人グループ間で、貸し借りの記録を改ざん不可能な形で共有する
- ブロックチェーン技術の学習と実用を兼ねる

### 1.2 技術スタック

- 言語: Go
- 暗号方式: Ed25519（署名・検証）
- ハッシュ: SHA-256
- 通信: HTTP（Go標準ライブラリ `net/http`）
- 永続化: JSONL / JSONファイル
- 外部フレームワーク: 使用しない（フルスクラッチ）

### 1.3 ネットワーク構成

P2Pゴシップ型。各ノードが対等にチェーンを保持し、ブロックをブロードキャストで伝播する。

---

## 2. データ構造

### 2.1 Block

| フィールド | 型 | 説明 |
|---|---|---|
| Index | int | ブロック番号 |
| Timestamp | time.Time | ブロック作成日時 |
| Transaction | Transaction | トランザクション（1ブロック1トランザクション） |
| PrevHash | string | 前ブロックのSHA-256ハッシュ |
| Hash | string | このブロックのSHA-256ハッシュ |

ハッシュ計算の対象: Index + Timestamp + Transaction + PrevHash を文字列連結しSHA-256で算出。

### 2.2 Transaction

汎用的なペイロード構造を採用し、種別ごとに異なるデータを格納する。

| フィールド | 型 | 説明 |
|---|---|---|
| Type | string | トランザクション種別 |
| Payload | json.RawMessage | 種別に応じた任意のJSON |
| Signature | string（またはバイト列） | 署名（種別により複数） |

### 2.3 Payload定義

#### Type: "register"（ユーザー登録）

| フィールド | 型 | 説明 |
|---|---|---|
| Username | string | ユーザー名 |
| PublicKey | string | Ed25519公開鍵（Base64等） |

#### Type: "transfer"（貸し借り記録）

| フィールド | 型 | 説明 |
|---|---|---|
| From | string | 貸した人のユーザー名 |
| To | string | 借りた人のユーザー名 |
| Amount | int | 金額（円単位、整数） |
| Memo | string | 用途メモ（例: 「飲み会代」） |
| FromSignature | string | Fromの署名 |
| ToSignature | string | Toの署名 |

署名対象は Type + Payload の生バイト列。transfer では From と To の両者が署名する（双方合意）。

### 2.4 PendingTransaction（未承認トランザクション）

ブロックチェーンには載らない仮データ。

| フィールド | 型 | 説明 |
|---|---|---|
| ID | string | UUID等の一意識別子 |
| CreatedAt | time.Time | 提案日時 |
| Transaction | Transaction | From署名済み、To署名未済のトランザクション |

---

## 3. ブロックチェーンコアロジック

### 3.1 ジェネシスブロック

チェーンの起点。トランザクションは空（またはダミー）、PrevHash は固定値 `"0"`。

### 3.2 ブロック追加

1. トランザクション（両者署名済み）を受け取る
2. チェーン末尾ブロックの Hash を PrevHash にセット
3. Index, Timestamp, Transaction を格納
4. CalcHash でハッシュを計算し Hash に格納
5. チェーンに追加
6. JSONL に追記
7. 全ピアにブロードキャスト

### 3.3 チェーン検証

全ブロックを先頭から走査し、以下を確認する:

1. 各ブロックの Hash を再計算し、保存されている Hash と一致するか（改ざん検知）
2. 各ブロックの PrevHash が、ひとつ前のブロックの Hash と一致するか（チェーンの連続性）

---

## 4. ブロック受信時の検証フロー

ピアから `POST /block` でブロックを受信した際、以下の順に検証する。

### チェック1: ハッシュ再計算

受信ブロックの中身からハッシュを再計算し、記載されている Hash と一致するか確認。不一致なら拒否。

### チェック2: PrevHash 整合性

| 条件 | 対応 |
|---|---|
| 自分のチェーン末尾の Hash と一致 | 正常。チェーンに追加し他ピアへ転送 |
| 一致しないが Index が末尾より大きい | 自分が遅れている。送信元に `GET /chain` で同期 |
| Index が末尾以下 | 既知 or 古いブロック。無視 |

### チェック3: トランザクション検証

- register: ユーザー名の重複がないか
- transfer: From の公開鍵で FromSignature を検証、To の公開鍵で ToSignature を検証。From と To が同一でないか、Amount が 0 以下でないか

### チェック4: 重複検知

同じ Hash のブロックを既に保持していないか確認（既知 Hash をセットで管理）。ゴシップによる多重受信を防止。

---

## 5. 最長チェーンルール（コンフリクト解決）

`GET /chain` で他ノードからチェーン全体を受け取った場合の判定。

### 5.1 受信チェーンの検証

ジェネシスブロックから末尾まで全ブロックに対してチェーン検証（3.3）を実施。途中で不正があれば丸ごと破棄。

### 5.2 置き換え判定

| 条件 | 対応 |
|---|---|
| 相手のチェーンが長い | 自分のチェーンを丸ごと置き換え |
| 長さが同じ | 置き換えない（先着優先） |
| 自分の方が長い | 置き換えない |

### 5.3 失われるトランザクションの扱い

置き換えにより自分のチェーンにのみ存在したトランザクションは失われる。送信者が再度トランザクションを提案する運用とする（10人弱の頻度では同時衝突は稀）。

---

## 6. 認証・ユーザー識別

### 6.1 鍵ペア

各ユーザーが Ed25519 の秘密鍵・公開鍵ペアを持つ。Go 標準ライブラリ `crypto/ed25519` を使用。

### 6.2 ユーザー登録

ユーザー名と公開鍵の紐付けをブロックチェーン上に記録する（Type: "register" のトランザクション）。全ノードが同じ登録情報を持てるため同期の問題が発生しない。

### 6.3 双方署名（transfer）

貸し借り記録は From と To の両者が署名しなければブロックに入らない。一方的な虚偽記録を防止する。

### 6.4 秘密鍵の管理

- ローカルファイルに保存（PEM または Base64 エンコード）
- 初回起動時に存在しなければ自動生成
- 紛失した場合は新ユーザーとして再登録する運用

---

## 7. ネットワーク層

### 7.1 ピアディスカバリ

起動時に設定ファイルから既知ピアリストを読み込む。新ピアの追加は API 経由。

### 7.2 ブロックブロードキャスト

新ブロック生成時、自分の全ピアに `POST /block` で送信。受信ピアは検証後、さらに自分のピアへ転送。既知ブロック（Hash 重複）は無視して無限ループを防止。

### 7.3 チェーン同期

ノードの新規参加・オフライン復帰時にピアへ `GET /chain` を発行し、最長チェーンルールで同期。

---

## 8. APIエンドポイント

### 8.1 取引系

| メソッド | パス | 説明 |
|---|---|---|
| POST | /transaction/propose | 貸し借りを提案。From署名付きトランザクションをToのノードに送信 |
| GET | /transaction/pending | 自分宛の未承認トランザクション一覧 |
| POST | /transaction/approve | 未承認トランザクションをIDで指定して承認。To署名を追加しブロック生成→ブロードキャスト |
| POST | /transaction/reject | 未承認トランザクションをIDで指定して拒否。pendingから削除 |

### 8.2 ユーザー登録

| メソッド | パス | 説明 |
|---|---|---|
| POST | /register | ユーザー登録（registerトランザクションをブロック生成→ブロードキャスト） |

### 8.3 同期系

| メソッド | パス | 説明 |
|---|---|---|
| GET | /chain | チェーン全体をJSONで返却 |
| POST | /block | ピアからのブロック受信。検証→追加→転送 |

### 8.4 ピア管理系

| メソッド | パス | 説明 |
|---|---|---|
| GET | /peers | 既知ピアリストを返却 |
| POST | /peers | 新しいピアを登録 |

---

## 9. 永続化

| 対象 | 形式 | ファイル名 |
|---|---|---|
| ブロックチェーン | JSONL（1行1ブロック、追記方式） | signet.jsonl |
| 未承認トランザクション | JSONL | signet-pending.jsonl |
| ピアリスト | JSON（上書き方式） | signet-peers.json |
| 秘密鍵 | PEM / Base64 | signet.key |

最長チェーンルールによるチェーン置き換え時のみ、signet.jsonl を全体書き直し。

---

## 10. ノード起動フロー

1. 秘密鍵ファイル（signet.key）を読み込む。存在しなければ鍵ペアを生成しファイルに保存
2. チェーンファイル（signet.jsonl）を読み込む。存在しなければジェネシスブロックを生成
3. 未承認トランザクション（signet-pending.jsonl）を読み込む
4. ピアリスト（signet-peers.json）を読み込む
5. ピアに `GET /chain` を発行し、最長チェーンルールで同期
6. HTTPサーバー起動、通常運用開始

---

## 11. 実装順序

1. データ構造（Block, Transaction, Payload 各種）
2. ブロック生成・チェーン検証ロジック
3. JSONL 永続化
4. Ed25519 鍵生成・署名・検証
5. HTTPエンドポイント（単体ノードとして動作確認）
6. ピア間ブロードキャスト・チェーン同期
7. 未承認トランザクションフロー（propose / approve / reject）
